<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Camera Tree View -->
    <record id="view_cctv_camera_tree" model="ir.ui.view">
        <field name="name">cctv.camera.tree</field>
        <field name="model">cctv.camera</field>
        <field name="arch" type="xml">
            <tree string="Cameras">
                <field name="name"/>
                <field name="camera_brand"/>
                <field name="ip_address"/>
                <field name="mediamtx_path"/>
                <field name="status" decoration-success="status=='online'" decoration-danger="status=='offline'" decoration-warning="status=='draft'"/>
                <field name="location"/>
                <field name="active" widget="boolean_toggle"/>
            </tree>
        </field>
    </record>

    <!-- Camera Form View -->
    <record id="view_cctv_camera_form" model="ir.ui.view">
        <field name="name">cctv.camera.form</field>
        <field name="model">cctv.camera</field>
        <field name="arch" type="xml">
            <form string="Camera">
                <header>
                    <button name="action_test_connection" string="Test Connection" type="object" class="btn-primary"/>
                    <button name="action_trigger_mediamtx_sync" string="Sync to MediaMTX" type="object" class="btn-secondary"/>
                    <button name="action_view_live_feed" string="View Live Feed" type="object" class="btn-success" icon="fa-video-camera"/>
                    <field name="status" widget="statusbar" statusbar_visible="draft,online,offline,error"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button" options="{'terminology': 'archive'}"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="e.g., Front Door Camera"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Connection Details">
                            <field name="rtsp_url" placeholder="rtsp://admin:password@192.168.1.100:554/Streaming/Channels/101"/>
                            <field name="ip_address" readonly="1"/>
                            <field name="port"/>
                            <field name="camera_brand"/>
                            <field name="stream_quality"/>
                        </group>
                        <group string="Location">
                            <field name="location" placeholder="e.g., Building A, Floor 1"/>
                            <field name="last_check" readonly="1"/>
                        </group>
                    </group>
                    <group string="Streaming Settings">
                        <group>
                            <field name="transcoding_enabled"/>
                            <field name="target_bitrate" invisible="not transcoding_enabled"/>
                        </group>
                        <group>
                            <field name="mediamtx_path" readonly="1"/>
                        </group>
                    </group>
                    <group string="Playback URLs" col="1">
                        <group>
                            <field name="webrtc_url" readonly="1" widget="url"/>
                            <field name="hls_url" readonly="1" widget="url"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Live Preview" invisible="not webrtc_url">
                            <group>
                                <div class="alert alert-info" role="alert">
                                    <p><strong>üìπ Live Feed Available</strong></p>
                                    <p>Your camera stream is ready. Click "View Live Feed" button above or use one of the URLs below:</p>
                                </div>
                                <group>
                                    <field name="webrtc_url" readonly="1" widget="url" string="WebRTC URL (Low Latency)"/>
                                    <field name="hls_url" readonly="1" widget="url" string="HLS URL (Fallback)"/>
                                </group>
                                <div class="alert alert-warning" role="alert">
                                    <p><strong>‚ÑπÔ∏è How to View:</strong></p>
                                    <ul>
                                        <li>Click the <strong>"View Live Feed"</strong> button at the top to open in a new window</li>
                                        <li>Or copy the WebRTC URL and open in your browser</li>
                                        <li>Or use the test player: <code>file:///home/shadman/docker/mediamtx/test-player.html</code></li>
                                    </ul>
                                    <p><small>Note: First connection may take 5-15 seconds while FFmpeg starts transcoding.</small></p>
                                </div>
                            </group>
                        </page>
                        <page string="Notes">
                            <field name="notes" placeholder="Add any notes about this camera..."/>
                        </page>
                        <page string="Error Log" invisible="not error_message">
                            <field name="error_message" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Camera Kanban View -->
    <record id="view_cctv_camera_kanban" model="ir.ui.view">
        <field name="name">cctv.camera.kanban</field>
        <field name="model">cctv.camera</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="id"/>
                <field name="name"/>
                <field name="status"/>
                <field name="webrtc_url"/>
                <field name="location"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title"><field name="name"/></strong>
                                    <div class="o_kanban_record_subtitle">
                                        <field name="location"/>
                                    </div>
                                </div>
                                <span class="float-end badge rounded-pill" t-attf-class="badge-{{record.status.raw_value === 'online' ? 'success' : record.status.raw_value === 'offline' ? 'danger' : 'warning'}}">
                                    <field name="status"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="mediamtx_path"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <field name="camera_brand"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Camera Action -->
    <record id="action_cctv_camera" model="ir.actions.act_window">
        <field name="name">Cameras</field>
        <field name="res_model">cctv.camera</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Add your first camera
            </p>
            <p>
                Configure CCTV cameras to stream via WebRTC.<br/>
                Cameras will be automatically synchronized with MediaMTX.
            </p>
        </field>
    </record>
</odoo>
